/*
 Copyright 2012 Ilya Lakhin (Илья Александрович Лахин)

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */
(function(){var a=this,b=function(a){if(b.typecheck.isArray(a)||b.typecheck.isObject(a))return new b.Generator(a);if(b.typecheck.isNumber(a)){var c=Math.floor(a),d=arguments[1]!==undefined&&b.typecheck.isNumber(arguments[1])?Math.ceil(arguments[1]):c+1;return new b.Range(c,d)}};b.installer=function(){var a={},b={deploy:function(a,c){return b.install(a,arguments[1],arguments[2])?b.enable(a):!1},install:function(c,d){return b.isInstalled(c)?!1:(Object.prototype.toString.call(d)!=="[object Array]"&&(d=[{destination:arguments[1],source:arguments[2],safe:!1}]),a[c]={retainCount:0,targets:d},!0)},uninstall:function(c){return!b.isInstalled(c)||b.isEnabled(c)?!1:(delete a[c],!0)},isInstalled:function(b){return a[b]!==undefined},isEnabled:function(b){return a[b]!==undefined&&a[b].retainCount>0},getAllPackages:function(b){if(b.length>1&&b.indexOf("*",b.length-1)!==-1){b=b.substr(0,b.length-1);var c=[];for(var d in a)a.hasOwnProperty(d)&&d.indexOf(b,0)===0&&c.push(d);return c}return a[b]===undefined?[]:[b]},enable:function(c,d){if(!b.isInstalled(c))return!1;var e=a[c];if(d!==undefined)return b.enable(c)?(d(),b.disable(c)):(e.retainCount++,d(),e.retainCount--),!0;if(e.retainCount>0)return!1;e.retainCount=1;for(var f=0,g=e.targets.length;f<g;f++){var h=e.targets[f],i=h.source,j=h.destination,k=h.safe,l={};for(var m in i)if(i.hasOwnProperty(m))if(!k||j[m]===undefined){var n=i[m];l[m]=j[m],j[m]=n}h.obscuredFields=l}return!0},disable:function(c,d){if(!b.isInstalled(c))return!1;var e=a[c];if(d!==undefined){if(b.disable(c))d(),b.enable(c);else{var f=e.retainCount;e.retainCount=1,b.disable(c),d(),b.enable(c),e.retainCount=f}return!0}if(e.retainCount!==1)return!1;for(var g=e.targets.length-1;g>=0;g--){var h=e.targets[g],i=h.source,j=h.destination,k=h.obscuredFields;for(var l in i)i.hasOwnProperty(l)&&(j[l]=k[l]);delete h.obscuredFields}return e.retainCount=0,!0}};return b}(),b.functions=function(){var a=Function.prototype.bind,c=Array.prototype.slice,d={bind:function(b,d){if(b.bind===a&&a)return a.apply(b,c.call(arguments,1));var e=c.call(arguments,2),f=function(){var a=e.concat(c.call(arguments));if(this instanceof f){var g=function(){};g.prototype=b.prototype;var h=new g,i=b.apply(h,a);return Object(i)===i?i:h}return b.apply(d,a)};return f},unbind:function(a){return function(){var b=c.call(arguments);return b.unshift(this),a.apply(a,b)}},asynchronous:function(a,b){return b===undefined&&(b=0),function(){setTimeout(a,b)}},limit:function(a,b){var c=0;return function(){var d=(new Date).getTime();d-c>=b&&(c=d,a.apply(this,arguments))}},cache:function(a){var b,c=!1;return function(){return c||(b=a.apply(this,arguments),c=!0),b}}};return b.installer.install("kira.functions",[{source:{bind:d.unbind(d.bind),unbind:d.unbind(d.unbind),asynchronous:d.unbind(d.asynchronous),limit:d.unbind(d.limit),cache:d.unbind(d.cache)},destination:Function.prototype,safe:!0}]),d}(),b.typecheck={isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return a===Object(a)},isArguments:function(a){return Object.prototype.toString.call(a)==="[object Arguments]"},isFunction:function(a){return Object.prototype.toString.call(a)==="[object Function]"},isString:function(a){return Object.prototype.toString.call(a)==="[object String]"},isNumber:function(a){return Object.prototype.toString.call(a)==="[object Number]"},isDate:function(a){return Object.prototype.toString.call(a)==="[object Date]"},isRegExp:function(a){return Object.prototype.toString.call(a)==="[object RegExp]"}},b.installer.install("kira.typecheck",[{source:b.typecheck,destination:a,safe:!0}]),b.console=function(){var c=a.console.log,d={watch:function(a){return c(a),a},profile:function(a){var b=(new Date).getTime();return a(),(new Date).getTime()-b}};return b.installer.install("kira.console",[{source:d,destination:a.console},{source:{watch:d.watch,profile:d.profile},destination:a,safe:!0}]),d}(),b.objects=function(){var a=Object.getOwnPropertyNames,c={extend:function(){var a={};for(var b=0,c=arguments.length;b<c;b++){var d=arguments[b];if(d!==undefined)for(var e in d)d.hasOwnProperty(e)&&(a[e]=d[e])}return a},append:function(a,b,c){return c===undefined?a.push(b):a[b]=c,a},keys:function(b){if(a!==undefined)return a(b);var c=[];for(var d in b)b.hasOwnProperty(d)&&c.push(d);return c}};return b.installer.install("kira.objects",[{source:{extend:b.functions.unbind(c.extend),keys:b.functions.unbind(c.keys)},destination:Object.prototype}]),c}(),b.arrays=function(){var a=Array.prototype.forEach,c=Array.prototype.filter,d=Array.prototype.map,e=Array.prototype.every,f=Array.prototype.some,g=Array.prototype.reduce,h=Array.prototype.indexOf,i={map:function(a,b){if(a.map===d&&d!==undefined)return d.call(a,b);var c=[];for(var e=0,f=a.length;e<f;e++)c.push(b(a[e]));return c},flat:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++){var f=b(a[d]);for(var g=0,h=f.length;g<h;g++)c.push(f[g])}return c},filter:function(a,b){if(a.filter===c&&c!==undefined)return c.call(a,b);var d=[];for(var e=0,f=a.length;e<f;e++){var g=a[e];b(g)&&d.push(g)}return d},zip:function(a,b){var c=[];for(var d=0,e=Math.min(a.length,b.length);d<e;d++)c.push([a[d],b[d]]);return c},each:function(b,c){if(b.forEach===a&&a!==undefined)return a.call(b,c);for(var d=0,e=b.length;d<e;d++)c(b[d])},group:function(a,b){var c={};for(var d=0,e=a.length;d<e;d++){var f=a[d],g=b(f);c[g]===undefined?c[g]=[f]:c[g].push(f)}return c},all:function(a,b){if(a.every===e&&e!==undefined)return e.call(a,b);for(var c=0,d=a.length;c<d;c++)if(!b(a[c]))return!1;return!0},any:function(a,b){if(a.some===f&&f!==undefined)return f.call(a,b);for(var c=0,d=a.length;c<d;c++)if(!b(a[c]))return!1;return!0},reduce:function(a,b){if(a.reduce===g&&g!==undefined)try{return[g.call(a,b)]}catch(c){if(c.type==="reduce_no_initial")return[];throw c}var d=a.length;if(d>0){var e=a[0];for(var f=1;f<d;f++)e=b(e,a[f]);return[e]}return[]},fold:function(a,b,c){if(a.reduce===g&&g!==undefined)return g.call(a,c,b);for(var d=0,e=a.length;d<e;d++)b=c(b,a[d]);return b},find:function(a,b){var c;return i.any(a,function(a){return b(a)?(c=a,!0):!1})?[c]:[]},indexOf:function(a,b){if(a.indexOf===h&&h!==undefined){var c=h.call(a,b);return c>=0?[c]:[]}for(var d=0,e=a.length;d<e;d++)if(a[d]===b)return[d];return[]},toSet:function(a){var b={};for(var c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b},toGenerator:function(a){return new b.Generator(a)}},j={flat:b.functions.unbind(i.flat),zip:b.functions.unbind(i.zip),each:a,group:b.functions.unbind(i.group),all:e,any:f,reduce:b.functions.unbind(i.reduce),fold:b.functions.unbind(i.fold),find:b.functions.unbind(i.find),indexOf:b.functions.unbind(i.indexOf),toSet:b.functions.unbind(i.toSet),toGenerator:b.functions.unbind(i.toGenerator)};return d===undefined&&(j.map=b.functions.unbind(i.map)),c===undefined&&(j.filter=b.functions.unbind(i.filter)),a===undefined&&(j.each=b.functions.unbind(i.each)),e===undefined&&(j.all=b.functions.unbind(i.all)),f===undefined&&(j.any=b.functions.unbind(i.any)),f===undefined&&(j.any=b.functions.unbind(i.any)),b.installer.install("kira.arrays",[{source:j,destination:Array.prototype}]),i}(),b.options=function(){var c={get:function(a,c,d){return d===undefined?b.options.getOption(a,c):b.typecheck.isFunction(d)?b.options.getOrElseLazy(a,c,d):b.options.getOrElse(a,c,d)},getOption:function(a,b){var c=a[b];return c===undefined?[]:[c]},getOrElse:function(a,b,c){var d=a[b];return d===undefined?c:d},getOrElseLazy:function(a,b,c){var d=a[b];return d===undefined?c():d},orElse:function(a,c,d){return b.typecheck.isFunction(d)?b.options.orElseLazy(a,c,d):b.options.orElseOption(a,c,d)},orElseOption:function(a,b,c){var d=a[b];return d===undefined?c:[d]},orElseLazy:function(a,b,c){var d=a[b];return d===undefined?c():[d]},nullable:function(a){return a===null||a===undefined?[]:[a]}};return b.installer.install("kira.options",[{source:{get:b.functions.unbind(c.get),orElse:b.functions.unbind(c.orElse)},destination:Object.prototype},{source:{nullable:c.nullable},destination:a,safe:!0}]),c}(),b.Generator=function(a){a!==undefined&&(b.typecheck.isArray(a)?this.iterator=function(){var b=a.length,c=0;return{next:function(){if(c<b)return a[c++]}}}:this.iterator=function(){var c=b.objects.keys(a),d=c.length,e=0;return{next:function(){if(e<d){var b=c[e++];return[b,a[b]]}}}})},b.Generator.empty=new b.Generator,b.Generator.prototype.iterator=function(){return{next:function(){}}},b.Generator.prototype.cache=function(){var a=this,c,d=new b.Generator;return d.iterator=function(){if(c===undefined){var d=[],e=a.iterator();return{next:function(){var a=e.next();return a!==undefined?d.push(a):c=new b.Generator(d),a}}}return c.iterator()},d},b.Generator.prototype.map=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator();return{next:function(){var c=b.next();if(c!==undefined)return a(c)}}},d},b.Generator.prototype.flat=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d,e;return{next:function(){e!==undefined&&(e=d.next());if(e===undefined)do{var c=b.next();if(c===undefined)return;d=a(c).iterator(),e=d.next()}while(e===undefined);return e}}},d},b.Generator.prototype.filter=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator();return{next:function(){var c;do c=b.next();while(c!==undefined&&!a(c));return c}}},d},b.Generator.prototype.zip=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d=a.iterator();return{next:function(){var a=b.next(),c=d.next();if(a!==undefined&&c!==undefined)return[a,c]}}},d},b.Generator.prototype.drop=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d=!1;return{next:function(){if(!d){d=!0;for(var c=0;c<a;c++)if(b.next()===undefined)return}return b.next()}}},d},b.Generator.prototype.dropWhile=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d=!1;return{next:function(){while(!d){var c=b.next();if(c===undefined)return;d=!a(c);if(d)return c}return b.next()}}},d},b.Generator.prototype.limit=function(a,c){var d=this,e=new b.Generator;return e.iterator=function(){var b=d.iterator(),e=!1,f;return{next:function(){if(!e){e=!0,f=-1;while(++f<a)if(b.next()===undefined)return}if(f++<c)return b.next()}}},e},b.Generator.prototype.take=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d=0;return{next:function(){if(d++<a)return b.next()}}},d},b.Generator.prototype.takeWhile=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d=!0;return{next:function(){if(d){var c=b.next();if(c!==undefined&&(d=a(c)))return c}}}},d},b.Generator.prototype.concatenate=function(a){var c=this,d=new b.Generator;return d.iterator=function(){var b=c.iterator(),d;return{next:function(){if(d===undefined){var c=b.next();return c===undefined?(d=a.iterator(),d.next()):c}return d.next()}}},d},b.Generator.prototype.each=function(a){for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())if(a(c)===!1)break},b.Generator.prototype.all=function(a){for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())if(!a(c))return!1;return!0},b.Generator.prototype.any=function(a){for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())if(a(c))return!0;return!1},b.Generator.prototype.fold=function(a,b){for(var c=this.iterator(),d=c.next();d!==undefined;d=c.next())a=b(a,d);return a},b.Generator.prototype.reduce=function(a){var b=this.iterator(),c=b.next();if(c===undefined)return[];for(;;){var d=b.next();if(d===undefined)break;c=a(c,d)}return[c]},b.Generator.prototype.find=function(a){for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())if(a(c))return[c];return[]},b.Generator.prototype.index=function(a){var b=0;for(var c=this.iterator(),d=c.next();d!==undefined;d=c.next()){if(a(d))return[b];b++}return[]},b.Generator.prototype.get=function(a){var b=0;for(var c=this.iterator(),d=c.next();d!==undefined;d=c.next()){if(b===a)return[d];b++}return[]},b.Generator.prototype.toArray=function(){var a=[];for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())a.push(c);return a},b.Generator.prototype.toSet=function(){var a={};for(var b=this.iterator(),c=b.next();c!==undefined;c=b.next())a[c]=!0;return a},b.Range=function(a,b){this._defined=a!==undefined&&b!==undefined&&a<=b,this._defined?(this._left=a,this._right=b,this._length=b-a):(this._left=0,this._right=0,this._length=0)},b.Range.notdefined=new b.Range,b.Range.index=new b.Range(0,268435456),b.Range.prototype.isDefined=function(){return this._defined},b.Range.prototype.getLeft=function(){return this._left},b.Range.prototype.getRight=function(){return this._right},b.Range.prototype.getLength=function(){return this._length},b.Range.prototype.map=function(a,c){return this._defined?new b.Range(a(this._left),c===undefined?a(this._right):c(this._right)):this},b.Range.prototype.union=function(a){return b.typecheck.isNumber(a)?this.unionWithPoint(a):this.unionWithRange(a)},b.Range.prototype.unionWithPoint=function(a){return a=Math.floor(a),this._defined?new b.Range(Math.min(a,this._left),Math.max(a+1,this._right)):new b.Range(a,a+1)},b.Range.prototype.unionWithRange=function(a){return this._defined&&a._defined?new b.Range(Math.min(this._left,a._left),Math.max(this._right,a._right)):this._defined?this:a},b.Range.prototype.inject=function(a){return this._defined&&a._defined?a._right<=this._left?new b.Range(a._left,this._right+a._length):a._left<=this._left?new b.Range(a._left,a._right+this._length):a._right<=this._right?new b.Range(a._left,this._right+a._length):a._left<=this._right?new b.Range(this._left,this._right+a._length):new b.Range(this._left,a._right):this._defined?this:a},b.Range.prototype.takeout=function(a){return this._defined&&a._defined?this._right<=a._left?this:a._right<=this._left?new b.Range(this._left-a._length,this._right-a._length):this._left<=a._left?new b.Range(this._left,Math.max(this._right-a._length,a._left)):new b.Range(a._right,this._right-a._left):this},b.Range.prototype.enlarge=function(a){return this._defined?new b.Range(this._left-a[0],this._right+a[1]):this},b.Range.prototype.shift=function(a){return this._defined?new b.Range(this._left+a,this._right+a):this},b.Range.prototype.sub=function(a){return b.typecheck.isString(a)?this.substring(a):this.subarray(a)},b.Range.prototype.replace=function(a,c){return b.typecheck.isString(a)?this.replaceString(a,c):this.replaceArray(a,c)},b.Range.prototype.substring=function(a){return this._defined?a.substring(this._left,this._right):""},b.Range.prototype.replaceString=function(a,b){return this._defined?a.substring(0,this._left)+b+a.substring(this._right):a},b.Range.prototype.subarray=function(a){return this._defined?a.slice(this._left,this._right):[]},b.Range.prototype.replaceArray=function(a,b){var c=a.slice(0);if(this._defined){var d=b.slice(0);d.unshift(this._left,this._length),c.splice.apply(c,d)}return c},b.Range.prototype.limit=function(a){if(this._defined){var c=this._left,d=this._right,e=new b.Generator;return e.iterator=function(){var b=a.iterator(),e=!1,f;return{next:function(){if(!e){e=!0,f=-1;while(++f<c)if(b.next()===undefined)return}if(f++<d)return b.next()}}},e}return this},b.Range.prototype.toGenerator=function(){var a=this;if(this._defined){var c=new b.Generator;return c.iterator=function(){var b=a._left-1;return{next:function(){b++;if(b<a._right)return b}}},c}return b.Generator.empty},b.Range.prototype.toReversedGenerator=function(){var a=this;if(this._defined){var c=new b.Generator;return c.iterator=function(){var b=a._right;return{next:function(){b--;if(b>=a._left)return b}}},c}return b.Generator.empty},b.Range.prototype.toOption=function(){return this._defined?[this]:[]},b.Range.prototype.toString=function(){return this._defined?"Range("+this._left+", "+this._right+")":"Range()"},function(){var c=b.objects.extend({autoDeploy:!1},a.kira);b.installer.deploy("kira",a,{kira:b}),b.noConflict=function(){return b.installer.disable("kira"),b.installer.uninstall("kira"),b};var d=!1,e=b.installer.getAllPackages("kira.*");b.deploy=function(){d||(d=!0,b.arrays.each(e,function(a){b.installer.enable(a)}))},b.undeploy=function(){d&&(b.arrays.each(e,function(a){b.installer.disable(a)}),d=!1)},c.autoDeploy&&b.deploy()}()})();